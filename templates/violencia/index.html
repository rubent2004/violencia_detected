{% extends 'baseV.html' %}
{% load static %}

{% block head_title %}Subir Video{% endblock head_title %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/styles.css' %}">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
{% endblock extra_head %}

{% block content %}
<div class="container mt-5">
    {# ——— Bloque de descarga de modelos ——— #}
    {% if modelos_faltantes %}
    <div class="alert alert-warning text-center">
        <p>Faltan los siguientes modelos en el servidor:</p>
        <ul class="list-inline">
            {% for m in modelos_faltantes %}
            <li class="list-inline-item badge badge-pill badge-secondary p-2">{{ m }}</li>
            {% endfor %}
        </ul>
        <button id="btn-descargar-modelos" class="btn btn-primary">
            <i class="fas fa-download"></i> Descargar modelos
        </button>
        <span id="status-modelos" class="ml-3 font-italic"></span>

        <div id="progress-container" class="mt-3" style="display:none;">
            <div class="progress">
                <div id="progress-bar"
                     class="progress-bar progress-bar-striped progress-bar-animated"
                     role="progressbar"
                     style="width: 0%">0%</div>
            </div>
        </div>
    </div>
    {% endif %}

    {# ——— Formulario de subida de videos ——— #}
    <form method="POST" enctype="multipart/form-data" class="mt-4">
        {% csrf_token %}
        <h1 class="title text-center">Subir Video <i class="fas fa-video"></i></h1>

        <div class="upload-section text-center mt-4">
            <label for="videoInput" class="btn btn-outline-primary">
                <i class="fas fa-upload"></i> Seleccionar Video(s)
            </label>
            <input type="file" id="videoInput" name="video" hidden required multiple>
        </div>

        <div class="video-list mt-4">
            <h3 class="text-center">Vista previa de Videos</h3>
            <div id="videoList" class="row">
                <!-- Se agregarán dinámicamente -->
            </div>
        </div>

        <input type="hidden" name="thumbnail" id="thumbnailData">
        <input type="hidden" name="prediction" value="{{ prediction }}">

        <div class="text-center mt-4">
            <button type="submit" class="btn btn-outline-light" id="acceptBtn">
                <i class="fas fa-check"></i> Aceptar
            </button>
        </div>

        {% if error %}
        <div class="alert mt-4 alert-danger text-center">{{ error }}</div>
        {% endif %}
    </form>
</div>
{% endblock content %}

{% block extra_body %}
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
$(function () {
    // — Descarga de modelos con barra de progreso —
    $('#btn-descargar-modelos').on('click', function () {
        $(this).prop('disabled', true);
        $('#status-modelos').text('Iniciando descarga…');
        $('#progress-container').show();
        const $bar = $('#progress-bar');
        let percent = 0;
        const sim = setInterval(() => {
            if (percent < 90) {
                percent += Math.floor(Math.random() * 10) + 1;
                if (percent > 90) percent = 90;
                $bar.css('width', percent + '%').text(percent + '%');
            }
        }, 300);

        fetch("{% url 'descargar_modelos' %}")
        .then(res => res.json())
        .then(data => {
            clearInterval(sim);
            $bar.css('width', '100%').text('100%');
            const errs = Object.entries(data)
                .filter(([_, v]) => v.startsWith('error'))
                .map(([n, e]) => `${n}: ${e}`);
            if (errs.length) {
                $('#status-modelos').text('Errores: ' + errs.join('; '));
                $bar.removeClass('progress-bar-animated').addClass('bg-danger');
            } else {
                $('#status-modelos').text('Modelos descargados. Recarga la página.');
            }
        })
        .catch(e => {
            clearInterval(sim);
            $bar.removeClass('progress-bar-animated').addClass('bg-danger')
                .css('width','100%').text('Error');
            $('#status-modelos').text('Error inesperado: ' + e);
        });
    });

    // — Vista previa de videos y captura de miniatura —
    $('#videoInput').on('change', function () {
        $('#videoList').empty();
        Array.from(this.files).forEach(file => {
            const url = URL.createObjectURL(file);
            const video = document.createElement('video');
            video.src = url; video.currentTime = 1;
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            video.addEventListener('loadeddata', function () {
                canvas.width = 400; canvas.height = 200;
                ctx.drawImage(video, 0, 0, 400, 200);
                const thumb = canvas.toDataURL();
                $('#videoList').append(`
                    <div class="col-md-4 mb-4">
                        <div class="card bg-dark text-light shadow-sm" style="border-radius:10px;">
                            <img src="${thumb}" class="card-img-top" style="border-top-left-radius:10px;border-top-right-radius:10px;">
                            <div class="card-body">
                                <h5 class="card-title">${file.name}</h5>
                                <button type="button" class="btn btn-danger remove-btn">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </div>
                        </div>
                    </div>`);
                $('#thumbnailData').val(thumb);
            });
            video.load();
        });
    });

    // Eliminar vista previa
    $(document).on('click', '.remove-btn', function () {
        $(this).closest('.col-md-4').remove();
    });

    // Validar antes de enviar
    $('#acceptBtn').on('click', function (e) {
        if ($('#videoList .col-md-4').length === 0) {
            e.preventDefault();
            alert('Por favor, sube al menos un video.');
        }
    });
});
</script>
{% endblock extra_body %}
